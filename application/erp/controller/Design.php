<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/5/23
 * Time: 13:02
 */

namespace app\erp\controller;

use app\base\controller\PDF;
use app\base\controller\Word;
use app\base\model\Base;
use app\base\model\budget\BudgetBookNumber;
use app\base\model\budget\DefaultProjectCopy;
use app\base\model\budget\PrintRequest;
use app\base\model\BudgetDefaultBook;
use app\base\model\BudgetDefaultRate;
use app\base\model\BudgetDefaultProject;
use app\base\model\design\DesignCheck;
use app\base\model\design\DesignField;
use app\base\model\design\DesignPhoto;
use app\base\model\DesignBudgetAccess;
use app\base\model\DesignBudgetListAccess;
use app\base\model\DesignPhase;
use app\base\model\MaterialListEdit;
use app\base\model\PersonnelDepartment;
use app\base\model\PersonnelUser;
use app\base\model\Project;
use app\base\model\ProjectContacts;
use app\base\model\ProjectRelatedPerson;
use app\base\model\DesignBudget;
use app\base\model\ProjectRemindTime;
use app\base\model\ProjectStructure;
use app\base\model\ProjectBuilding;
use app\base\model\ProjectTraceLog;
use app\erp\config\FieldValue;
use app\erp\controller\template_message\SendTemplateMessage;
use think\Exception;
use think\Loader;
use think\Session;
use app\erp\config\Config;


class Design extends Auth
{
    public function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
//        $this->config_list = Config::$Design;
    }
    /*图片上传*/
    public function showUploadHtml($idName="",$idM=""){
        config(['default_ajax_return' => 'html',]);
        $assign_data= [
            'idName'=>$idName,
            'idM'=>empty($idM)?'photo_m':$idM,
        ];
        $this->assign($assign_data);
        return $this->fetch('photo_html_up');
    }
    /*附件上传*/
    public function showUploadFile($idName="",$idM=""){
        config(['default_ajax_return' => 'html',]);
        $assign_data= [
            'idName'=>$idName,
            'idM'=>empty($idM)?'field_m':$idM,
        ];
        $this->assign($assign_data);
        return $this->fetch('file_html_up');
    }

    /*在设计汇总*/
    public function showProListByCom(){
        if($this->request->isPost()){
            $model="base/Project";
            $department_type=array_search("设计部",FieldValue::getFieldValue("department_type"))?:3;
            $list=$this->showEasyUiJsonList($model,false,["company_id"=>$this->member_info->company_id,'feedback_stage'=>'2'],false,false);
            $model=new PersonnelDepartment();
            foreach($list["rows"] as $value){
                $ad=Loader::model("base/ProjectAudit")->getDataByProject(["project_id"=>$value["guid"],'transfer_type'=>'2']);
                $track=Loader::model("base/ProjectRelatedPerson")->where(["project_id"=>$value["guid"],'department_type'=>$department_type])->select();
                $dep_name=$model->getInfoByGuId($value['design_department']);
                //$dep_name=PersonnelDepartment::quickGet($value['design_department']);
                $value['design_department_name']=empty($dep_name)? '' :$dep_name['department_name'];
                if(empty($ad)){
                    $value["transfer_status"]="0";
                    $value["transfer_desc"]="";
                    $value["examine_status"]="";
                    $value["examine_desc"]="";
                }else{
                    $value["transfer_status"]=$ad[0]["transfer_status"];  //转部状态
                    $value["transfer_desc"]=$ad[0]["transfer_desc"];
                    $value["examine_status"]=$ad[0]["examine_status"];    //审核状态
                    $value["examine_desc"]=$ad[0]["examine_desc"];
                }
                if(empty($track)){
                    $value["tracking_name"]="";
                }else{
                    $str='';
                    $key_last = key($track); //获取最后一个下标
                    foreach($track as $k => $v){
                        $depart_id=PersonnelUser::quickGet($v["uuid"])["department_id"];
                        if ( $k != $key_last ){
                            $str.="".PersonnelDepartment::quickGet("$depart_id")["department_name"]."---".PersonnelUser::quickGet($v["uuid"])["name"].',';
                        }else{
                            $str.="".PersonnelDepartment::quickGet("$depart_id")["department_name"]."---".PersonnelUser::quickGet($v["uuid"])["name"];
                        }
                    }
                    $value["tracking_name"]=$str;
                }
            }
            return $list;
        }else{
            config(['default_ajax_return' => 'html',]);
            $assign_data= [
                'title' => '项目表',
                'dialog_url' => 'projectEdit',
                'data_url' => url('showProListByCom'),
            ];
            $this->assign($assign_data);
            return $this->fetch('project_user_all');
        }
    }
    
    /*部门的设计表*/
    public function showProListByDep(){
        if($this->request->isPost()){
            $model="base/Project";
            $department_type=array_search("设计部",FieldValue::getFieldValue("department_type"))?:3;
            $list=$this->showEasyUiJsonList($model,false,["company_id"=>$this->member_info->company_id,'feedback_stage'=>'2'],false,false);
            $arr=[];
            $arr['rows']=[];
            foreach($list["rows"] as $value){
                $ad=Loader::model("base/ProjectAudit")->getDataByProject(["project_id"=>$value["guid"],'transfer_type'=>'2']);
                $track=Loader::model("base/ProjectRelatedPerson")->where(["project_id"=>$value["guid"],'department_type'=>$department_type])->select();
                $dep_name=PersonnelDepartment::quickGet($value['design_department']);
                $value['design_department_name']=empty($dep_name)? '' :$dep_name['department_name'];
                if(empty($ad)){
                    $value["transfer_status"]="0";
                    $value["transfer_desc"]="";
                    $value["examine_status"]="";
                    $value["examine_desc"]="";
                }else{
                    $value["transfer_status"]=$ad[0]["transfer_status"];  //转部状态
                    $value["transfer_desc"]=$ad[0]["transfer_desc"];
                    $value["examine_status"]=$ad[0]["examine_status"];    //审核状态
                    $value["examine_desc"]=$ad[0]["examine_desc"];
                }
                if(empty($track)){
                    $value["tracking_name"]="";
                }else{
                    $str='';
                    $key_last = key($track); //获取最后一个下标
                    foreach($track as $k => $v){
                        $depart_id=PersonnelUser::quickGet($v["uuid"])["department_id"];
                        if ( $k != $key_last ){
                            $str.="".PersonnelDepartment::quickGet("$depart_id")["department_name"]."---".PersonnelUser::quickGet($v["uuid"])["name"].',';

                        }else{
                            $str.="".PersonnelDepartment::quickGet("$depart_id")["department_name"]."---".PersonnelUser::quickGet($v["uuid"])["name"];
                        }
                    }
                    $value["tracking_name"]=$str;
                }
                if($value['design_department']==$this->member_info->department_id){
                    $arr['rows'][]=$value;
                }
            }
            $arr['total']=$list['total'];
            return $arr;
        }else{
            config(['default_ajax_return' => 'html',]);
            $assign_data= [
                'title' => '项目表',
                'dialog_url' => 'projectEdit',
                'data_url' => url('showProListByDep'),
            ];
            $this->assign($assign_data);
            return $this->fetch('project_dep_all');
        }
    }
    /*查看项目关系人(功能实现)*/
    public function showProjectPerson($guid=""){
        if(empty($guid)){
            return self::showReturnCodeWithOutData(1003);
        }
        if($this->request->isAjax()){

        }else{
            return self::showReturnCodeWithOutData(1003);
        }
    }

    /*显示设计师*/
    public function showAssignPersonnel($guid="",$action=''){
        if(empty($guid)){
            return self::showReturnCodeWithOutData(1003);
        }
        config(['default_ajax_return' => 'html',]);
        $project=Loader::model("base/Project")->getInfoByGuId($guid);
        $assign_data= [
            'url'=>url('getUserJson',["guid"=>$guid]),
            'guid'=>$guid,
            'project_name'=>$project["project_name"],
            'action'=>$action ? $action :'add',
        ];
        $this->assign($assign_data);
        return $this->fetch('assign_personnel');
    }

    public function getUserJson($guid=""){
        $model = "base/PersonnelUser";
        $data=$this->request->Post();
        $data["page"]="";
        $data["rows"]="";
        $filed=new FieldValue();
        foreach($filed->department_type as $key => $value){
            if($value=="设计部"){
               $type=$key;
            }
        }
        $list = $this->showEasyUiJsonList($model, false, ["company_id"=>$this->member_info->company_id,'department_type'=>$type], false, false);

        if(!empty($list["rows"])){
            foreach($list["rows"] as $value){
                $total=Loader::model("base/ProjectRelatedPerson")->where(['uuid'=>$value["uuid"],'department_type'=>$type])->count();
                $value['trace_num']=$total;
                if(!empty($guid)){
                    $check=Loader::model("base/ProjectRelatedPerson")->where(['uuid'=>$value["uuid"],"project_id"=>$guid,'department_type'=>2])->count();
                    $value['check']=$check;
                }
            }
        }
        return $list;
    }
    /*分配设计师页面及部门人员*/
    public function showAssignPersonnelOfDepartment($guid="",$action=''){
        if ($this->request->isPost()){
            $model = "base/PersonnelUser";
            $data=$this->request->Post();
            $data["page"]="";
            $data["rows"]="";
            $filed=new FieldValue();
            foreach($filed->department_type as $key => $value){
                if($value=="设计部"){
                    $type=$key;
                }
            }
            $list = $this->showEasyUiJsonList($model, false, ["company_id"=>$this->member_info->company_id,'department_type'=>$type,'department_id'=>$this->member_info->department_id], false, false);

            if(!empty($list["rows"])){
                foreach($list["rows"] as $value){
                    $total=Loader::model("base/ProjectRelatedPerson")->where(['uuid'=>$value["uuid"],'department_type'=>$type])->count();
                    $value['trace_num']=$total;
                    if(!empty($guid)){
                        $check=Loader::model("base/ProjectRelatedPerson")->where(['uuid'=>$value["uuid"],"project_id"=>$guid,'department_type'=>2])->count();
                        $value['check']=$check;
                    }
                }
            }
            return $list;
        }else{
            if(empty($guid)){
                return self::showReturnCodeWithOutData(1003);
            }
            config(['default_ajax_return' => 'html',]);
            $project=Loader::model("base/Project")->getInfoByGuId($guid);
            $assign_data= [
                'url'=>url('showAssignPersonnelOfDepartment',["guid"=>$guid]),
                'guid'=>$guid,
                'project_name'=>$project["project_name"],
                'action'=>$action ? $action :'add',
            ];
            $this->assign($assign_data);
            return $this->fetch('assign_personnel_dep');
        }


    }

    /*添加项目设计师*/
    public function addComplaintUuid(){
        if($this->request->isPost()){
            $data=$this->request->post();
            $data["company_id"]=$this->member_info->company_id;
            $model=new ProjectRelatedPerson();
            $re=$model->saveProjectRelatedPerson($data);
            if($re["code"]=="1001"){
                $model=new ProjectTraceLog();
                $log=[];
                $log["log_content"]= $data["action"]=="edit"? "修改设计师分配" :"分配设计师";
                $log["guid"]=$data["guid"];
                $log["uuid"]=$this->uuid;
                $log["jobs_id"]=$this->member_info->jobs_id;
                $log['department_id']=$this->member_info->department_id;
                $model->addProjectLog($log);
            }
            return $re;
        }else{
            return self::showReturnCodeWithOutData(1003);
        }
    }
    /*解除设计师分配*/
    public function delAssignPersonnel(){
        if($this->request->isPost()){
            $data=$this->request->post();
            $model=new ProjectRelatedPerson();
            $re=$model->delProjectRelatedPerson($data);
            if($re["code"]=="1001"){
                $model=new ProjectTraceLog();
                $log=[];
                $log["log_content"]="解除设计师分配";
                $log["guid"]=$data["id"];
                $log["uuid"]=$this->uuid;
                $log["jobs_id"]=$this->member_info->jobs_id;
                $log['department_id']=$this->member_info->department_id;
                $model->addProjectLog($log);
            }
            return $re;
        }else{
            return self::showReturnCodeWithOutData(1003);
        }
    }
    /*个人的项目设计表*/
    public function showProListByUser(){
        if($this->request->isPost()){
            $department_type=array_search("设计部",FieldValue::getFieldValue("department_type"))?:3;
            $arr=[];
            $arr["rows"]=[];
            $proList=Loader::model("base/ProjectRelatedPerson")->getList(["uuid"=>$this->member_info->uuid,'department_type'=>$department_type],"project_id");
            foreach($proList as $value){
                $c=Loader::model("base/Project")->getInfoByGuId($value["project_id"],["company_id"=>$this->member_info->company_id,'feedback_stage'=>'2']);
                if (!empty($c)){
                    $arr["rows"][]=$c;
                }
            }
            if (!empty($arr["rows"])){
                foreach($arr["rows"] as $value) {
                    if (empty($value)) {
                        continue;
                    }
                    $ad = Loader::model("base/ProjectAudit")->getDataByProject(["project_id" => $value["guid"], 'transfer_type' => '2', 'status' => 1]);
                    $track = Loader::model("base/ProjectRelatedPerson")->where(["project_id" => $value["guid"], 'department_type' => $department_type])->select();
                    $count=Loader::model("base/BudgetDefaultBook")->where(['project_id'=>$value["guid"],'status'=>1])->count();
                    if ($count>0) {  //判断该项目是否创建了预算
                        $value['budget'] = 1;
                    } else {
                        $value['budget'] = 0;
                    }
                    $ch = Loader::model('base/budget/ReviseBudget')->getFind(['project_id' => $value['guid']]);
                    $value['changeStatus'] = 0;   //判断该项目的预算有没有申请预算修改
                    if (!empty($ch)) {
                        if ($ch['examine_status'] == 0) {
                            $value['changeStatus'] = 1;
                        }
                    }
                    if (empty($ad)) {
                        $value["transfer_status"] = "0";
                        $value["transfer_desc"] = "";
                        $value["examine_status"] = "";
                        $value["examine_desc"] = "";
                    } else {
                        $value["transfer_status"] = $ad[0]["transfer_status"];  //转部状态
                        $value["transfer_desc"] = $ad[0]["transfer_desc"];
                        $value["examine_status"] = $ad[0]["examine_status"];    //审核状态
                        $value["examine_desc"] = $ad[0]["examine_desc"];
                    }
                    if (empty($track)) {
                        $value["tracking_name"] = "";
                    } else {
                        $str='';
                        $key_last = key($track); //获取最后一个下标
                        foreach($track as $k => $v){

                            $depart_id=PersonnelUser::quickGet($v["uuid"])["department_id"];
                            if ( $k != $key_last ){
                                $str.="".PersonnelDepartment::quickGet("$depart_id")["department_name"]."---".PersonnelUser::quickGet($v["uuid"])["name"].',';

                            }else{
                                $str.="".PersonnelDepartment::quickGet("$depart_id")["department_name"]."---".PersonnelUser::quickGet($v["uuid"])["name"];
                            }
                        }
                        $value["tracking_name"]=$str;
                    }
                }
            }
            $arr["total"]=count($proList);
            return $arr;
        }else{
            config(['default_ajax_return' => 'html',]);
            $assign_data= [
                'title' => '个人项目表',
                'dialog_url' => '',
                'data_url' => url('showProListByUser'),
            ];
            $this->assign($assign_data);
            return $this->fetch('project_user');
        }
    }

    public function showProListByUserCopy(){
        $madel=new Project();
        $list=$madel->showProListByUserCopy($this->uuid,$this->member_info->company_id);
        return json($list);
    }


    /*设计转部审核*/
    public function showProjectTransfer(){
        if($this->request->isPost()){
            $list=$this->showEasyUiJsonListNoStatus('base/ProjectAudit',false,["company_id"=>$this->member_info->company_id,'examine_status'=>'0','transfer_status'=>'1','transfer_type'=>'2','status'=>'1'],false,false);
            foreach($list["rows"] as $v){
                $userData=PersonnelUser::quickGet($v["transfer_uuid"]);
                $department=PersonnelDepartment::quickGet($userData["department_id"]);
                $v["name"]=$userData["name"];
                $v["department_name"]=$department["department_name"];
                $project=Loader::model("base/Project")->getPerByGuid($v["project_id"]);
                $v["project_name"]=$project["project_name"];
                $v['project_cid']=$project["id"];
            }
            return $list;
        }else{
            $assign_data = [
                'title' => '转部审核',
                'data_url' => "showProjectTransfer",
            ];
            $this->assign($assign_data);
            return $this->fetch('project_transfer');
        }
    }
    //取消转部(已不用 因为设计部转工程会根据收到 ‘首付款’自动转入)
    public function delAudit(){
        if ($this->request->isPost()){
            $data=$this->request->post();
            if (empty($data)) return self::showReturnCodeWithOutData(1003);
            if (!isset($data['pro_id'])) return self::showReturnCodeWithOutData(1003);
            $re=Loader::model("base/ProjectAudit")->del($data['pro_id']);
            if ($re['code']=="1001"){
                $model=new ProjectTraceLog();
                $log=[];
                $log["log_content"]='取消设计阶段的转部申请';
                $log["guid"]=$data['pro_id'];
                $log["uuid"]=$this->uuid;
                $log["jobs_id"]=$this->member_info->jobs_id;
                $log['department_id']=$this->member_info->department_id;
                $model->addProjectLog($log);
            }
            return $re;
        }else{
            return self::showReturnCodeWithOutData(1003);
        }
    }
    //转部审核(同上)
    public function showProjectEditAudit($action="",$guid="",$id=""){
        if(empty($guid)){
            return self::showJsonReturnCode("1003");
        }
        if(empty($action)){
            return self::showJsonReturnCode("1003");
        }
        switch($action){
            case "show":
                config(['default_ajax_return' => 'html',]);
                if(empty($guid)){
                    return self::showJsonReturnCode("1003");
                }
                $list=Loader::model("base/Project")->getPerByGuId($guid);
                if(empty($list)){
                    return self::showJsonReturnCode("1003");
                }
                $assign_data = [
                    'guid'=>isset($list->guid) ? $list->guid : '' ,
                    'project_name'=>isset($list->project_name) ? $list->project_name : '',
                ];
                $this->assign($assign_data);
                return $this->fetch('project/project_transfer_audit');
                break;
            case "add":
                if(empty($id)){
                    return self::showJsonReturnCode("1003");
                }
                $data=$this->request->post();
                $validate_name = 'base/ProjectAudit.save';
                $result = $this->validate($data, $validate_name);
                if(gettype($result)=='string'){
                    return ['code' => '1003', 'msg' => $result,];
                }
                $arr=[
                    "examine_status"=>$data['examine_status'],
                    "examine_desc"=>$data["examine_desc"],
                    'examine_uuid'=>$this->member_info->uuid,
                    'transfer_status'=>'2', //已经申请过的
                    'transfer_type'=>2,
                ];
                $va=Loader::model('base/ProjectAudit')->where(['id'=>$id])->value('transfer_status');
                if($va=="1"){
                    $re=Loader::model("base/ProjectAudit")->save($arr,["id"=>$id]);
                }else{
                    return ['code' => '1003', 'msg' => '该项目已经审核过了,请重新刷新数据',];
                }
                $model_project=new Project();
                $req=$model_project->where(['guid'=>$guid,'status'=>1])->value('feedback_stage');
                switch ($req){  //判断是从哪个阶段提交的转部申请
                    case "1":
                        $text='业务阶段转设计阶段审核';
                        break;
                    case "2":
                        $text='设计阶段转工程阶段审核';
                        break;
                    default:
                        $text='未知转部审核';
                        break;
                }
                if($data['examine_status']=="1"){
                    $rq=Loader::model("base/Project")->save(["feedback_stage"=>'3'],["guid"=>$guid]);
                    if($rq!="1"){
                        return ['code' => '1010', 'msg' => '转部失败，请联系管理员',];
                    }
                }

                if($re=="1"){
                    $model=new ProjectTraceLog();
                    $log=[];
                    $log["log_content"]=$text;
                    $log["guid"]=$guid;
                    $log["uuid"]=$this->uuid;
                    $log["jobs_id"]=$this->member_info->jobs_id;
                    $log['department_id']=$this->member_info->department_id;
                    $model->addProjectLog($log);
                    return ['code' => '1001', 'msg' => '审核成功',];
                }
                break;
            default:;
        }
    }

    /*进入预算报价页面*/
    public function addBudget($id=""){
        if (empty($id)) return self::showJsonReturnCode(1003);
        $model=new PrintRequest();
//        $list=$model->setCacheProjectData()['project'];
        $project=new Project();
        $list=$project->where(['guid'=>$id,'status'=>'1'])->find();
        if($list['feedback_stage']!="2")  return self::showJsonReturnCodeWithOutData(1003,'该项目不处于设计阶段');
//        if($list[$id]['status']=="-1")  return self::showJsonReturnCodeWithOutData(1003,'该项目已被删除了');
        $none=$model->getList(['project_id'=>$id]); //判断该项目是否审核通过
        config(['default_ajax_return' => 'html',]);
        $assign_data= [
            'guid'=>$id,
        ];
        $this->assign($assign_data);
        if (!empty($none)){
            if ($none[0]['examine_status']=="1"){
                return $this->fetch('add_budget_copy_yes');
            }else if($none[0]['examine_status']=="0"){
                return $this->fetch('add_budget_copy_status');
            }else{
                return $this->fetch('add_budget_copy');
            }
        }else{
            return $this->fetch('add_budget_copy');
        }

    }
    /*显示空间数据页面*/
    public function showBudget($guid=''){
        if (empty($guid)) return self::showJsonReturnCode(1003);
        config(['default_ajax_return' => 'html',]);
        $assign_data= [
            'url'=>url('showBudgetJson'),
            'guid'=>$guid,
        ];
        $this->assign($assign_data);
        return $this->fetch('show_budget_data');
    }
    public function showTemBudgetJson(){
        $list=Loader::model('base/MaterialTemplateStyle')->getList(["company_id"=>$this->member_info->company_id]);
        return $list;
    }
    public function showBudgetJson(){
        $list=$this->showEasyUiJsonListNoStatus('base/MaterialTemplateBudget',false,["company_id"=>$this->member_info->company_id,'status'=>1],false,false);
        return $list;
    }
    /*添加预算空间*/
    public function addBudgetData(){
        if($this->request->isPost()){
            $data=$this->request->post();
            $model=new BudgetDefaultProject();
            if(!isset($data['project_guid']) || !isset($data['oldTemp_guid'])){
                return self::showJsonReturnCode(1003);
            }
            $budget=$model->setCacheProjectData()['project_budget'];
            if(!empty($budget)){
                foreach ($budget as $value){
                    if($value['project_id']==$data['project_guid'] && $value['old_guid']==$data['oldTemp_guid'] && $value['name']==$data['new_name'] && $value['status']=="1"){
                        return self::showJsonReturnCodeWithOutData(1020,'此空间已经存在');
                    }
                }
            }
            $tem=Loader::model('base/MaterialTemplateBudget')->getInfoByGuId($data['oldTemp_guid']);
            $arr=[];
            $arr['uuid']=$this->member_info->uuid;
            $arr['company_id']=$this->member_info->company_id;
            $arr['name']=$data['new_name'];
            $arr['desc']=$tem['budget_desc'];
            $arr['pid']=0;
            $arr['project_id']=$data['project_guid'];
            $arr['old_guid']=$data['oldTemp_guid'];
            return $model->saveBudgetData($arr);

        }else{
            return self::showJsonReturnCode(1003);
        }

    }
    /*获取预算的空间树*/
    public function showSpaceTree($id=""){
        if (empty($id)) return self::showReturnCodeWithOutData(1003);
        $list=Loader::model('base/BudgetDefaultProject')->getList(['company_id'=>$this->member_info->company_id,'project_id'=>$id,'pid'=>0]);
        $arr=[];
        $arr['rows']=[];
        $model=new BudgetDefaultProject();
        $sum=0;
        if (!empty($list)){
            foreach ($list as $value){
                $price=0;
                $lists=$model->getList(['company_id'=>$this->member_info->company_id,'project_id'=>$id,'pid'=>$value['guid']]);
                foreach ($lists as $v){
                    $re= $v['price'] ? $v['price'] : 0 ;
                    $number=empty($v['number']) ? 0 : $v['number'];
                    $price+=$re*$number;
                }
                $value['value']=$price;
                $value['iconCls']='icon-blank';//取消树节点的图标
                $arr['rows'][]=$value;
                $sum+=$price;
            }
        }
        return $arr;
    }
    /*获取预算的费率树*/
    public function showRateTree($id=""){
        if (empty($id)) return self::showReturnCodeWithOutData(1003);
        $list=Loader::model('base/BudgetDefaultProject')->getList(['company_id'=>$this->member_info->company_id,'project_id'=>$id,'pid'=>0]);
        $arr=[];
        $arr['rows']=[];
        $model=new BudgetDefaultProject();
        $sum=0;
        if (!empty($list)){
            foreach ($list as $value){
                $price=0;
                $lists=$model->getList(['company_id'=>$this->member_info->company_id,'project_id'=>$id,'pid'=>$value['guid']]);
                foreach ($lists as $v){
                    $re= $v['price'] ? $v['price'] : 0 ;
                    $number=empty($v['number']) ? 0 : $v['number'];
                    $price+=$re*$number;
                }
//                $value['value']=$price;
//                $value['iconCls']='icon-blank';//取消树节点的图标
//                $arr['rows'][]=$value;
                $sum+=$price;
            }
        }
        $model=new BudgetDefaultRate();
        $rate_list=$model->getList(['company_id'=>$this->member_info->company_id,'project_id'=>$id]);
        $sum_all=$sum;
        $arr['rows'][]=['name'=>'直接费','value'=>$sum,'iconCls'=>'icon-blank','guid'=>0];
        if (!empty($rate_list)){
            foreach ($rate_list as $value){
                $a=$value['rate_default_type'];
                $p=0;
                switch ($a){
                    case '*':
                        $sum_all+=$sum*$value['rate_default_value'];
                        $p=$sum*$value['rate_default_value'];
                        break;
                    case '-':
                        $sum_all+=$sum-$value['rate_default_value'];
                        $p=$sum-$value['rate_default_value'];
                        break;
                    case '/':
                        $sum_all+=$sum/$value['rate_default_value'];
                        $p=$sum/$value['rate_default_value'];
                        break;
                    case '+':
                        $sum_all+=$sum+$value['rate_default_value'];
                        $p=$sum+$value['rate_default_value'];
                        break;
                    default:
                        break;
                }
                $arr['rows'][]=[
                    'iconCls'=>'icon-blank',
                    'guid'=>$value['guid'],
                    'name'=>$value['rate_default_name'],
                    'value'=>$p,
                    'type'=>$a,
                    'rate_value'=>$value['rate_default_value'],
                ];
            }
        }
        $arr['footer'][]=['name'=>'合计','value'=>$sum_all,'iconCls'=>'icon-blank'];
        return $arr;
    }
    /*删除空间名称*/
    public function delSpaceData(){
        if ($this->request->isPost()){
           $data=$this->request->post();
           $model=new BudgetDefaultProject();
           if (empty($data['guid'])) return self::showJsonReturnCode(1003);
           return  json($model->delSpaceData($data['guid']));
        }else{
            return self::showJsonReturnCode(1003);
        }
    }
//    //删除主数据
//    public function delMaterialData(){
//        if ($this->request->isPost()){
//            $data=$this->request->post();
//            $model=new DesignBudget();
//            if (empty($data['guid'])) return self::showJsonReturnCode(1003);
//            return  json($model->delMaterialData($data['guid']));
//        }else{
//            return self::showJsonReturnCode(1003);
//        }
//    }
    /*获取预算空间的装饰项目列表*/
    public function showSpaceDataList($id=''){
        if (empty($id)) return self::showJsonReturnCode(1003);
        $model = new BudgetDefaultProject();
        $arr=[];
        $arr['rows']=[];
        $guid=$this->request->param('guid');
        $i=1;
        if(!empty($guid)){
            $list=$model->getList(['project_id'=>$id,'company_id'=>$this->member_info->company_id,'guid'=>$guid],'id,guid,pid,name,unit,number,price,desc');
            if (!empty($list)){
                $arr['rows'][]=[
                    'id'=>$list[0]['id'],
                    'guid'=>$list[0]['guid'],
                    'name'=>$list[0]['name'],
                    'desc'=>$list[0]['desc'],
                    'iconCls'=>'icon-blank',
                ];
                $children=$model->getList(['project_id'=>$id,'company_id'=>$this->member_info->company_id,'pid'=>$list[0]['guid']],'id,guid,pid,name,unit,number,price,desc');
                if (!empty($children)){
                    foreach ($children as $value){
                        $value['iconCls']='icon-blank';
                        $value['_parentId']=$list[0]['id'];
                        $arr['rows'][]=$value;
                        $i++;
                    }
                }
                //$arr['rows']=$brr;
            }
        }else{
            $list=$model->getList(['project_id'=>$id,'company_id'=>$this->member_info->company_id,'pid'=>0],'id,guid,pid,name,unit,number,price,desc');
            if (!empty($list)){
                $arr['rows'][]=[
                    'id'=>$list[0]['id'],
                    'guid'=>$list[0]['guid'],
                    'name'=>$list[0]['name'],
                    'desc'=>$list[0]['desc'],
                    'iconCls'=>'icon-blank',
                ];
                $children=$model->getList(['project_id'=>$id,'company_id'=>$this->member_info->company_id,'pid'=>$list[0]['guid']],'id,guid,pid,name,unit,number,price,desc');
                if (!empty($children)){
                    foreach ($children as $value){
                        $value['iconCls']='icon-blank';
                        $value['_parentId']=$list[0]['id'];
                        $arr['rows'][]=$value;
                        $i++;
                    }
                }
                //$arr['rows']=$brr;
            }
        }
        $arr['total']=count($list);
        return json($arr);
    }
    /*添加空间主数据*/
    public function addMaterialData($guid='',$project_id='',$type=''){
        if(empty($guid) || empty($project_id)){
            return self::showJsonReturnCode(1003);
        }
        $action=empty($type) ? 2 : $type;
        config(['default_ajax_return' => 'html',]);
        $model=new BudgetDefaultBook();
        $budget_type=$model->where(['project_id'=>$project_id,'status'=>1])->value('budget_type');
        switch ($action){
            case 2:
                $assign_data= [
                    'project_id'=>$project_id,
                    'url'=>url('materialDataList',['guid'=>$guid,'project_id'=>$project_id]),
                    'guid'=>$guid,
                    'type'=>'2',
                ];
                $this->assign($assign_data);
                return $this->fetch('add_material_copy');
                break;
            case 1:
                $assign_data= [
                    'project_id'=>$project_id,
                    'url'=>url('showDataList',['guid'=>$guid,'project_id'=>$project_id,'budget_type'=>$budget_type]),
                    'guid'=>$guid,
                    'type'=>'1',  //方便查找表   1  装饰项目表   2  主材表
                    'budget_type'=>$budget_type,
                ];
                $this->assign($assign_data);
                if($budget_type==3){
                    return $this->fetch('add_data_item_package');
                }
                return $this->fetch('add_data_item_copy');
                break;
            default:
                break;

        }

    }
    /*显示基装项数据 $guid相当于pid*/
    public function showDataList($guid='',$project_id="",$budget_type="1"){
        $model=new BudgetDefaultProject();
        $list=$this->showEasyUiJsonList('base/MaterialListEdit',false,["company_id"=>$this->member_info->company_id,'type'=>$budget_type]);
        if(!empty($list['rows'])){
            foreach ($list['rows'] as $value){
                $count =$model->getCont(['pid'=>$guid,'project_id'=>$project_id,'old_guid'=>$value['guid'],'status'=>1]);
                $value["item_status"]=$count;
                $one_price=$model->countPrice($value);
                $re=  $one_price['code']=="1001" ? $one_price['data'] : '' ;
                $value['price']=$re;
            }
        }
        return $list;
    }           //显示添加主材的数据 ，$guid相当于pid
    public function materialDataList($guid='',$project_id=''){
        $model=new BudgetDefaultProject();
        $list=$this->showEasyUiJsonList('base/Material',false,["company_id"=>$this->member_info->company_id]);
        $arr=[];
        $arr['rows']=[];
        if(!empty($list['rows'])){
            foreach ($list['rows'] as $key=>$value){
                $count = $model->getCont(['pid'=>$guid,'project_id'=>$project_id,'old_guid'=>$value['guid'],'status'=>1]);
                $brr['item_status']=$count;
                $brr['name']=$value['material_name'];
                $brr['unit']=$value['unit_name'];
                $brr['price']=$value['material_price'];
                $brr['guid']=$value['guid'];
                $arr['rows'][]=$brr;

            }
        }
        $arr['total']=$list['total'];
        return $arr;
    }
    /*保存空间主数据*/
    public function saveSpaceMaterial(){
        if ($this->request->isPost()){
            $data=$this->request->post();
            $model=new BudgetDefaultProject();
            $data['uuid']=$this->member_info->uuid;
            $data['company_id']=$this->member_info->company_id;
            return $model->saveSpaceMaterial($data);
        }else{
            return self::showJsonReturnCode(1003,[],'请求错误');
        }
    }
    /*显示预算费率页面（菜单节点中未找到）*/
    public function showRateHtml($pro_id=""){
        if (empty($pro_id)) return self::showJsonReturnCode(1003);
        $model=new Project();
        $pro_list=$model->setCacheProjectData()['project'];
        if (!isset($pro_list[$pro_id])) return self::showJsonReturnCode(1003,'该项目已不存在');
        if ($pro_list[$pro_id]['status']=="-1") return self::showJsonReturnCode(1003,'该项目已被删除');
        config(['default_ajax_return' => 'html',]);
        $assign_data=[
            'list_url'=>url("showRateJson",["pro_id"=>$pro_id]),
            'title'=>$pro_list[$pro_id]['project_name'],
            'pro_id'=>$pro_id,
        ];
        $this->assign($assign_data);
        return $this->fetch('show_rate_html');
    }

    public function showRateJson($pro_id=""){
        if (empty($pro_id)) return self::showJsonReturnCode(1003);
        $list=Loader::model("base/BudgetDefaultRate")->getList(["company_id"=>$this->member_info->company_id,'project_id'=>$pro_id],'guid,rate_default_name,rate_default_value,rate_default_type,desc');
        return $list;
    }
    /*为预算添加额外费率*/
    public function savaBudgetRate($project_id=""){
        if (empty($project_id)) return self::showJsonReturnCode(1003);
        if ($this->request->isPost()){
            $data=$this->request->post();
            $model=new BudgetDefaultRate();
            $validate_name='base/DefaultRate.save_rate';
            $result = $this->validate($data, $validate_name);
            if (true !== $result) return ['code' => '1003', 'msg' => $result,];
            $data['project_id']=$project_id;
            $data['company_id']=$this->member_info->company_id;
            return $model->addRate($data);
        }else{
            return self::showJsonReturnCode(1003);
        }
    }
    /*删除预算的一些费率*/
    public function delRateData(){
        if ($this->request->isPost()){
            $data=$this->request->post();
            $model=new BudgetDefaultRate();
            return $model->delRateData($data);
        }else{
            return self::showJsonReturnCode(1003);
        }
    }
    /*修改单个基装项目数量页面显示*/
    public function showEdit($guid=''){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        $model=new BudgetDefaultProject();
        $data=$model->setCacheProjectData()['project_budget'];
        if (!isset($data[$guid])) return self::showJsonReturnCode(1003);
        config(['default_ajax_return' => 'html',]);
        $assign_data=[
            'title'=>'原始数量',
            'value'=>$data[$guid]['number'],
            'name_title'=>'变更数量',
            'name'=>'number',
            'guid'=>$guid,
        ];
        $this->assign($assign_data);
        return $this->fetch('data_edit');
    }
    /*修改所有数量页面*/
    public function showDataNumberHtml($pro_id=""){
        if (empty($pro_id)) return self::showJsonReturnCode(1003);
        $model=new Project();
        $pro_list=$model->setCacheProjectData()['project'];
        if (!isset($pro_list[$pro_id])) return self::showJsonReturnCode(1003,'该项目已不存在');
        if ($pro_list[$pro_id]['status']=="-1") return self::showJsonReturnCode(1003,'该项目已被删除');
        config(['default_ajax_return' => 'html',]);
        $assign_data=[
            'list_url'=>url("showDataJson",["pro_id"=>$pro_id]),
            'title'=>$pro_list[$pro_id]['project_name'],
            'pro_id'=>$pro_id,
        ];
        $this->assign($assign_data);
        return $this->fetch('show_data_number_html');
    }
    /*修改空间备注页面*/
    public function showDataDescHtml($pro_id=""){
        if (empty($pro_id)) return self::showJsonReturnCode(1003);
        $model=new Project();
        $pro_list=$model->setCacheProjectData()['project'];
        if (!isset($pro_list[$pro_id])) return self::showJsonReturnCode(1003,'该项目已不存在');
        if ($pro_list[$pro_id]['status']=="-1") return self::showJsonReturnCode(1003,'该项目已被删除');
        config(['default_ajax_return' => 'html',]);
        $assign_data=[
            'list_url'=>url("showDataJsonDesc",["pro_id"=>$pro_id]),
            'title'=>$pro_list[$pro_id]['project_name'],
            'pro_id'=>$pro_id,
        ];
        $this->assign($assign_data);
        return $this->fetch('edit_data_desc');
    }
    /*菜单节点中未找到*/
    public function showDataJsonDesc($pro_id){
        if (empty($pro_id)) return self::showJsonReturnCode(1003);
        $model = new BudgetDefaultProject();
        $arr=[];
        $arr['rows']=[];
        $list=$model->getList(['project_id'=>$pro_id,'company_id'=>$this->member_info->company_id,'pid'=>0],'guid,pid,name,unit,number,price,desc');
        if (!empty($list)){
            foreach ($list as $value){
                $value['iconCls']='icon-blank';
                $value['name']=$value['name'];
                $value['editor']=false;
                $arr['rows'][]=$value;
            }
        }
        $arr['total']=count($arr['rows']);
        return $arr;
    }
    /**/
    public function showDataJson($pro_id=""){
        if (empty($pro_id)) return self::showJsonReturnCode(1003);
        $model = new BudgetDefaultProject();
        $arr=[];
        $arr['rows']=[];
        $i=1;
        $list=$model->getList(['project_id'=>$pro_id,'company_id'=>$this->member_info->company_id,'pid'=>0],'guid,pid,name,unit,number,price,desc');
        if (!empty($list)){
            foreach ($list as $value){
                $value['iconCls']='icon-blank';
                $value['name']=$i.'、'.$value['name'];
                $value['editor']=false;
                $arr['rows'][]=$value;
                $i++;
                $children=$model->getList(['project_id'=>$pro_id,'company_id'=>$this->member_info->company_id,'pid'=>$list[0]['guid']],'guid,pid,name,unit,number,price,desc');
                if (!empty($children)){
                    foreach ($children as $item){
                        $item['iconCls']='icon-blank';
                        $item['_parentId']=$value['guid'];
                        $arr['rows'][]=$item;
                    }
                }
            }
        }
        $arr['total']=count($arr['rows']);
        return $arr;
    }
    /*修改数量*/
    public function saveData($guid=""){
        if (empty($guid)&& isset($data['guid'])) return self::showJsonReturnCode(1003);
        if ($this->request->isPost()){
            $data=$this->request->post();
            $id=empty($guid) ? $data['guid']: $guid;
            $model=new BudgetDefaultProject();
            $validate_name='base/DesignNumber.add';
            $result = $this->validate($data, $validate_name);
            if (true !== $result) return ['code' => '1003', 'msg' => $result,];
            return $model->savaNumber($data,$id);
        }else{
            return self::showJsonReturnCode(1003,[],'请求错误');
        }
    }

    public function saveDataDesc($guid=""){
        if (empty($guid)&& isset($data['guid'])) return self::showJsonReturnCode(1003);
        if ($this->request->isPost()){
            $data=$this->request->post();
            $id=empty($guid) ? $data['guid']: $guid;
            $model=new BudgetDefaultProject();
            return $model->savaDesc($data,$id);
        }else{
            return self::showJsonReturnCode(1003,[],'请求错误');
        }
    }
    /*预算书类型*/
    public function budgetBook(){
        $list=Loader::model('base/BudgetListEdit')->getList(["company_id"=>$this->member_info->company_id]);
        return $list;
    }
    /*显示预算书页面 guid 是项目的id ,type是代表查看的形式*/
    public function showBudgetBook($guid="",$type=false){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        $model=new BudgetDefaultProject();
        $book=Loader::model("base/BudgetDefaultBook")->getBook($guid); //公司地址
        $numb_model=new BudgetBookNumber();
        $book_number=$numb_model->where(['project_id'=>$guid,'status'=>1])->value('book_number');
        $data=$model->getDataList($guid); //装修信息
        $contUser=Loader::model("base/ProjectContacts")->getProjectCont($guid);  //业主的信息
        $pro=Loader::model("base/Project")->getProject($guid); //项目的信息
        if (!empty($pro)){
            if (isset($pro['pro_style'])){
                $fi=new FieldValue();
                $pro['pro_style_name']=$fi->decoration_style[$pro['pro_style']];
            }
        }
        $sj_user=Loader::model("base/ProjectRelatedPerson")->getFind(['project_id'=>$guid,'department_type'=>3],'uuid');
        if (empty($sj_user)){
            $user_name='';
        }else{
            $user_name=Loader::model("base/PersonnelUser")->getList(["uuid"=>$sj_user['uuid']],'name,mobile');
        }
        $arr_u=[
            'name'=>empty($user_name) ?"": $user_name[0]['name'] ,
            'tel'=>empty($user_name) ?"":$user_name[0]['mobile'],
        ];
        $field=new FieldValue();
        if (isset($field->decoration_style[$book['budget_style']])){
            $book['budget_style']=$field->decoration_style[$book['budget_style']];
        }
        $assign_data=[
            'book'=>$book,
            'cont'=>$contUser,
            'project'=>$pro,
            'body'=>$data['body'],
            'foot'=>$data['foot'],
            'user'=>$arr_u,
            'project_id'=>$guid,
            'book_number'=>$book_number
        ];
        $this->assign($assign_data);
        $re=Loader::model('base/budget/PrintRequest')->getList(['project_id'=>$guid]);
        $a=0;
        if (!empty($re)){
            if ($re[0]['examine_status']==0){
                $a=1;
            }
        }
        switch($type){
            case "word":
                Word::downloadOnline($pro['name'],$this->fetch('budget_book_upload'));
                break;
            case "pdf":
                PDF::downLoadPDF($pro['name'],$this->fetch('budget_book_upload'));
                break;
            default:
                if ($a==1){
                    return $this->fetch('show_budget_book_s');
                }
                return $this->fetch('show_budget_book');
        }
    }
    /*查看签订合同之后的预算书*/
    public function showBudgetBookCopy($guid="",$type=false){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        $model=new DefaultProjectCopy();

        $book=Loader::model("base/BudgetDefaultBook")->getBook($guid); //公司地址
        $numb_model=new BudgetBookNumber();
        $book_number=$numb_model->where(['project_id'=>$guid,'status'=>1])->value('book_number');
        $data=$model->getDataList($guid,$book_number); //装修信息
        $contUser=Loader::model("base/ProjectContacts")->getProjectCont($guid);  //业主的信息
        $pro=Loader::model("base/Project")->getProject($guid); //项目的信息
        if (!empty($pro)){
            if (isset($pro['pro_style'])){
                $fi=new FieldValue();
                $pro['pro_style_name']=$fi->decoration_style[$pro['pro_style']];
            }
        }
        $sj_user=Loader::model("base/ProjectRelatedPerson")->getFind(['project_id'=>$guid,'department_type'=>3],'uuid');
        if (empty($sj_user)){
            $user_name='';
        }else{
            $user_name=Loader::model("base/PersonnelUser")->getList(["uuid"=>$sj_user['uuid']],'name,mobile');
        }
        $arr_u=[
            'name'=>empty($user_name) ?"": $user_name[0]['name'] ,
            'tel'=>empty($user_name) ?"":$user_name[0]['mobile'],
        ];
        $field=new FieldValue();
        if (isset($field->decoration_style[$book['budget_style']])){
            $book['budget_style']=$field->decoration_style[$book['budget_style']];
        }
        $assign_data=[
            'book'=>$book,
            'cont'=>$contUser,
            'project'=>$pro,
            'body'=>$data['body'],
            'foot'=>$data['foot'],
            'user'=>$arr_u,
            'project_id'=>$guid,
            'book_number'=>$book_number
        ];
        $this->assign($assign_data);
        $re=Loader::model('base/budget/PrintRequest')->getList(['project_id'=>$guid]);
        $a=0;
        if (!empty($re)){
            if ($re[0]['examine_status']==0){
                $a=1;
            }
        }
        switch($type){
            case "word":
                Word::downloadOnline($pro['name'],$this->fetch('budget_book_upload'));
                break;
            case "pdf":
                PDF::downLoadPDF($pro['name'],$this->fetch('budget_book_upload'));
                break;
            default:
                if ($a==1){
                    return $this->fetch('show_budget_book_s');
                }
                return $this->fetch('show_budget_book');
        }
    }
    /*预算审核的时候修改预算的工程名称*/
    public function reviseBudge($guid=""){
        if (empty($guid)) return self::showReturnCode(1003);
        if ($this->request->isPost()){
            $model=new BudgetDefaultProject();
            $list=$model->getList(['project_id'=>$guid]);
            return $list;
        }else{
            $assign_data=[
                'data_url'=>url('reviseBudge',['guid'=>$guid]),
                'add_url'=>url('addReviseBudge'),
                'guid'=>$guid
            ];
            $this->assign($assign_data);
            self::echoHtml();
            return $this->fetch('revise_budge');
        }
    }
    /*修改预算的工程名称后保存数据*/
    public function addReviseBudge(){
        if ($this->request->isPost()){
            $data=$this->request->post();
            $model=new BudgetDefaultProject();
            if (empty($data)) return self::showReturnCode(1003);
            if (!isset($data['name'])) return self::showReturnCode(1003);
            if (!isset($data['pid'])) return self::showReturnCode(1003);
            if(!empty($data['pid'])){
                $validate_name='base/MaterialDataItem.edit_budget';
                $result = $this->validate($data, $validate_name);
                if (true !== $result) return ['code' => '1003', 'msg' => $result,];
            }
            $re=$model->reviseBudge($data);
            if ($re['code']=="1001"){
                $log=[];
                $log["log_content"]='预算审核时修改预算工程名称';
                $log["guid"]=$data['project_id'];
                $log["uuid"]=$this->uuid;
                $log["jobs_id"]=$this->member_info->jobs_id;
                $log['department_id']=$this->member_info->department_id;
                Loader::model('base/ProjectTraceLog')->addProjectLog($log);
            }
            return $re;
        }else{
            return self::showReturnCode(1003);
        }
    }
    /*菜单节点中未找到*/
    public function showBook($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        $model=new DefaultProjectCopy();
        $numb_model=new BudgetBookNumber();
        $book_number=$numb_model->where(['project_id'=>$guid,'status'=>1])->value('book_number');
        $data=$model->getDataList($guid,$book_number); //装修信息
        $book=Loader::model("base/budget/DefaultBookCopy")->getBook($guid,$book_number); //公司地址
        $contUser=Loader::model("base/ProjectContacts")->getProjectCont($guid);  //业主的信息
        $pro=Loader::model("base/Project")->getProject($guid); //项目的信息
        if (!empty($pro)){
            if (isset($pro['pro_style'])){
                $fi=new FieldValue();
                $pro['pro_style_name']=$fi->decoration_style[$pro['pro_style']];
            }
        }
    //    $sj_user=Loader::model("base/BudgetDefaultProject")->getUserName($guid);
        $sj_user=Loader::model("base/ProjectRelatedPerson")->getFind(['project_id'=>$guid,'department_type'=>3],'uuid');
        if (empty($sj_user)){
            $user_name='';
        }else{
            $user_name=Loader::model("base/PersonnelUser")->getList(["uuid"=>$sj_user['uuid']],'name,mobile');
        }
        $arr_u=[
            'name'=>empty($user_name) ?"": $user_name[0]['name'] ,
            'tel'=>empty($user_name) ?"":$user_name[0]['mobile'],
        ];
        $field=new FieldValue();
        if (isset($field->decoration_style[$book['budget_style']])){
            $book['budget_style']=$field->decoration_style[$book['budget_style']];
        }
        $assign_data=[
            'book'=>$book,
            'cont'=>$contUser,
            'project'=>$pro,
            'body'=>$data['body'],
            'foot'=>$data['foot'],
            'user'=>$arr_u,
            'book_number'=>$book_number
        ];
        $this->assign($assign_data);
        $none=Loader::model('base/budget/PrintRequest')->getCont(['project_id'=>$guid,'examine_status'=>1]);
        if ($none==0){
            $str='<p>出现未知错误，请联系管理员</p>';
            return $str;
        }
        return $this->fetch('book_yes');

    }

    /*显示设计进度页面*/
    public function showBudgetHtml($guid="",$type=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        config(['default_ajax_return' => 'html',]);
        $project_list=Loader::model('base/Project')->setCacheProjectData()['project'];
        $assign_data=[
            'guid'=>$guid,
            'project_name'=>$project_list[$guid]['project_name'],
            'url'=>url('showBudgetList',['guid'=>$guid]),
            'data_url'=>url('showBudgetListEdit',['guid'=>$guid]),
        ];
        $this->assign($assign_data);
        $model=new DesignCheck();
        if (empty($type)){
            return $this->fetch('design_schedule');
        }else if ($type=="edit"){
            return $this->fetch('design_schedule_edit');
        }

    }
    /*设计进度验收权限*/
    public function editCheck(){
        $guid=$this->request->param('guid');
        $pro_id=$this->request->param('pro_id');
        if (empty($guid)) return self::showReturnCodeWithOutData(1003);
        if (empty($pro_id)) return self::showReturnCodeWithOutData(1003);
        if ($this->request->isPost()){
            $data=$this->request->post();
            if (empty($data)) return self::showReturnCodeWithOutData(1003);
            $model=new DesignCheck();
            $data['uuid']=$this->uuid;
            $data['name']=$this->member_info->name;
            $re=$model->editCheck($data,$guid);
            if($re['code']=='1001'){
                $log=[];
                $log["log_content"]='设计进度验收';
                $log["guid"]=$pro_id;
                $log["uuid"]=$this->uuid;
                $log["jobs_id"]=$this->member_info->jobs_id;
                $log['department_id']=$this->member_info->department_id;
                Loader::model('base/ProjectTraceLog')->addProjectLog($log);
            }
            return $re;
        }else{
            return self::showReturnCodeWithOutData(1003);
        }
    }
    /*显示新增设计进度页面*/
    public function showAddBudgetHtml(){
        config(['default_ajax_return' => 'html',]);
        return $this->fetch('add_design_schedule');
    }
    /*保存设计进度*/
    public function saveAddBudgetData($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        if($this->request->isPost()){
            $data=$this->request->post();
            $model=new DesignPhase();
            $validate_name='base/DesignSchedule.add';
            $data['start_data']=strtotime($data['start_data']);
            $result = $this->validate($data, $validate_name);
            if (true !== $result) return ['code' => '1003', 'msg' => $result,];
            $data['project_id']=$guid;
            $data['uuid']=$this->uuid;
            $data['company_id']=$this->member_info->company_id;
            return $model->saveData($data);

        }else{
             return self::showJsonReturnCode(1003);
        }
    }
    /*显示设计进度列表(菜单节点中不存在)*/
    public function showBudgetListEdit($guid=''){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        $model=new DesignPhase();
        $designPhaseData=$model->setCacheProjectData()['project_design'];//获取所有的设计进度
        $arr=[];
        foreach ($designPhaseData as $value){
            if($value['project_id']==$guid){
                $user=PersonnelUser::quickGet($value['uuid']);
                $value['design_user']=$user?$user['name']:""; //获取负责人
                $value['maturity_date']=date('Y/m/d H:m:s',$value['acceptance_date']); //到期天数
                $value['start_data']=date('Y-m-d',$value['start_data']);
                $time=$value['acceptance_date'];
                $value['acceptance_date']=date('Y-m-d',$value['acceptance_date']);
                $model_c=new DesignCheck();
                $req=$model_c->where(['sheet_id'=>$value['guid'],'status'=>1])->find();
                if (!empty($value['completion_date'])){
                    $value['completion_date']=date('Y-m-d',$value['completion_date']);
                }
                if (!empty($req)){
                    $value['app_status']="1";
                }
                    $arr['rows'][]=$value;
            }
        }
        return $arr;
    }
    /*显示设计进度列表*/
    public function showBudgetList($guid=''){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        $model=new DesignPhase();
        $designPhaseData=$model->setCacheProjectData()['project_design'];//获取所有的设计进度
        $arr=[];
//        $user=$model->setCacheSystem()['user'];
        foreach ($designPhaseData as $value){
            if($value['project_id']==$guid){
                $user=PersonnelUser::quickGet($value['uuid']);
                $value['design_user']=$user?$user['name']:""; //获取负责人
                $value['maturity_date']=date('Y/m/d H:m:s',$value['acceptance_date']); //到期天数
                $value['start_data']=date('Y-m-d',$value['start_data']);
                $time=$value['acceptance_date'];
                $value['acceptance_date']=date('Y-m-d',$value['acceptance_date']);
                $model_c=new DesignCheck();
                $req=$model_c->where(['sheet_id'=>$value['guid'],'status'=>1])->find();
                if (!empty($value['completion_date'])){
                    $value['completion_date']=date('Y-m-d',$value['completion_date']);
                }
                if (!empty($req)){
                    $value['app_status']="1";
                }
                $arr['rows'][]=$value;
            }
        }
        return $arr;
    }
    public function showDesc(){
        config(['default_ajax_return' => 'html',]);
        return $this->fetch('design_extract/show_apply_edit');
    }
    /*设计进度验收申请*/
    public function applyCheck(){
        if ($this->request->isPost()){
            $data=$this->request->post();
            if (empty($data)) return self::showJsonReturnCode(1003);
            if (!isset($data['guid'])||!isset($data['pro_id'])) return self::showJsonReturnCode(1003);
            $numb_model=new Project();
            $project_name=$numb_model->where(['guid'=>$data['pro_id']])->value('project_name');
            $model=new DesignCheck();
            $data['uuid']=$this->uuid;
            $data['name']=$this->member_info->name;
            $data['project_name']=$project_name;
            $data['company_id']=$this->member_info->company_id;
            $re=$model->saveCheck($data);
            if($re['code']=='1001'){
                $log=[];
                $log["log_content"]='设计进度验收申请';
                $log["guid"]=$data['pro_id'];
                $log["uuid"]=$this->uuid;
                $log["jobs_id"]=$this->member_info->jobs_id;
                $log['department_id']=$this->member_info->department_id;
                Loader::model('base/ProjectTraceLog')->addProjectLog($log);
                SendTemplateMessage::sendTemplateMessage('scheduleAcceptance');
            }
            return $re;
        }else{
            return self::showJsonReturnCode(1003);
        }
    }
    /*显示需要设计进度验收的项目*/
    public function showCheckList(){
        if ($this->request->isPost()){
            $model='base/design/DesignCheck';
            $list=$this->showEasyUiJsonListNo($model,false,['company_id'=>$this->member_info->company_id],false,false);
            return $list;
        }else{
            config(['default_ajax_return' => 'html',]);
            $assign_data= [
                'title' => '需审核项目',
                'data_url' => url('showCheckList'),
                'url'=>'',
            ];
            $this->assign($assign_data);
            return $this->fetch('design_extract/apply_check_list');
        }
    }
    /**/
    public function showSchedulePhotoHtml($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        config(['default_ajax_return' => 'html',]);
        $model=new DesignPhase();
        $designPhaseData=$model->setCacheProjectData()['project_design'];//获取所有的设计进度
        $assign_data=[
            'guid'=>$guid,
            'title'=>$designPhaseData[$guid]['design_phase'],
        ];
        $this->assign($assign_data);
        $m=new DesignPhase();
        $ar=$m->where(['guid'=>$guid])->value('status');
        if($ar=="2"){
            return $this->fetch('schedule_photo_copy');
        }
        return $this->fetch('schedule_photo');
    }
    public function showScheduleFieldHtml($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        config(['default_ajax_return' => 'html',]);
        $model=new DesignPhase();
        $designPhaseData=$model->setCacheProjectData()['project_design'];//获取所有的设计进度
        $assign_data=[
            'guid'=>$guid,
            'title'=>$designPhaseData[$guid]['design_phase'],
        ];
        $this->assign($assign_data);
        $m=new DesignPhase();
        $ar=$m->where(['guid'=>$guid])->value('status');
        if($ar=="2"){
            return $this->fetch('schedule_field_copy');
        }
        return $this->fetch('schedule_field');
    }
    /*显示设计进度图片列表*/
    public function showDesignPhotoList($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        $model=new DesignPhoto();
        $list=$model->getList(['design_id'=>$guid]);
        return $list;
    }
    /*显示设计进度文件列表*/
    public function showDesignFieldList($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        $model=new DesignField();
        $list=$model->getList(['design_id'=>$guid],'field_name,guid,uuid_name,field_m,create_time');
        return $list;
    }
    /*保存设计进度的图片*/
    public function saveDesignPhoto($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        if ($this->request->isPost()){
            $data=$this->request->post();
            if (empty($data)) return self::showJsonReturnCode(1003);
            $model=new DesignPhoto();
            $data['design_id']=$guid;
            $data['uuid_name']=$this->member_info->name;
            $data['uuid']=$this->uuid;
            return $model->savePhoto($data);
        }else{
            return self::showReturnCodeWithOutData(1003);
        }
    }
    /*保存设计进度的文件*/
    public function saveDesignField($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        if ($this->request->isPost()){
            $data=$this->request->post();
            if (empty($data)) return self::showJsonReturnCode(1003);
            $model=new DesignField();
            $data['design_id']=$guid;
            $data['uuid_name']=$this->member_info->name;
            $data['uuid']=$this->uuid;
            return $model->savePhoto($data);
        }else{
            return self::showReturnCodeWithOutData(1003);
        }
    }
    /*删除设计进度图片*/
    public function delPhoto(){
        if ($this->request->isPost()){
            $data=$this->request->post();
            if (empty($data)) return self::showJsonReturnCode(1003);
            $model=new DesignPhoto();
            return $model->delTem($data);
        }else{
            return self::showReturnCodeWithOutData(1003);
        }
    }
    public function delField(){
        if ($this->request->isPost()){
            $data=$this->request->post();
            if (empty($data)) return self::showJsonReturnCode(1003);
            $model=new DesignField();
            return $model->delTem($data);
        }else{
            return self::showReturnCodeWithOutData(1003);
        }
    }
    /*设计进度图片添加页面*/
    public function showAddSchedulePhotoHtml($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        config(['default_ajax_return' => 'html',]);
        $model=new DesignPhase();
        $designPhaseData=$model->setCacheProjectData()['project_design'];//获取所有的设计进度
        $assign_data=[
            'guid'=>$guid,
            'title'=>$designPhaseData[$guid]['design_phase'],
        ];
        $this->assign($assign_data);
        return $this->fetch('add_schedule_photo');
    }
    /*设计进度文件添加页面*/
    public function showAddScheduleFieldHtml($guid=""){
        if(empty($guid)) return self::showJsonReturnCode(1003);
        config(['default_ajax_return' => 'html',]);
        $model=new DesignPhase();
        $designPhaseData=$model->setCacheProjectData()['project_design'];//获取所有的设计进度
        $assign_data=[
            'guid'=>$guid,
            'title'=>$designPhaseData[$guid]['design_phase'],
        ];
        $this->assign($assign_data);
        return $this->fetch('add_schedule_field');
    }

    /*默认利润及损耗值设置*/
    public function showDefaultRate(){
        if($this->request->isPost()){
            $model="base/DefaultRate";
            $list=$this->showEasyUiJsonList($model,false,["company_id"=>$this->member_info->company_id],false,false,true);
            return $list;
        }else{
            config(['default_ajax_return' => 'html',]);
            $assign_data= [
                'title'=>'默认损耗费率列表',
                'data_url'=>url('showDefaultRate'),
                'map'=>["company_id"=>$this->member_info->company_id],
            ];
            $this->assign($assign_data);
            return $this->fetch('listedit/default_rate');
        }
    }
    /*添加默认损耗率数据*/
    public function addDataWithDefaultRate(){
        if($this->request->isPost()){
            $data=$this->request->post();
            $validate_name='base/DefaultRate.add';
            $result = $this->validate($data, $validate_name);
            if (true !== $result) return ['code' => '1003', 'msg' => $result,];
            $data['company_id']=$this->member_info->company_id;
            return Loader::model('base/DefaultRate')->saveDate($data);
        }else{
            return self::showJsonReturnCode("1003");
        }
    }
    /*删除默认损耗率*/
    public function delDataWithDefaultRate(){
        if($this->request->isPost()){
            $data=$this->request->post();
            return Loader::model('base/DefaultRate')->delData($data);
        }else{
            return self::showJsonReturnCode("1003");
        }
    }

    /*显示创建预算时，出现选择默认费率页面*/
    public function showRateItemAndBook($id=""){
        if(empty($id)) return self::showJsonReturnCode(1003);
        config(['default_ajax_return' => 'html',]);
        $count=Loader::model("base/BudgetDefaultBook")->where(['project_id'=>$id,'status'=>1])->count();
        if($count>0){  //判断该项目是否创建了预算

            $url=url("design/addbudget",["id"=>$id]);
          $str= "<script>window.parent.addTab('预算报价','$url','close');</script>";

            return $this->display($str);
        }

        $book=Loader::model('base/BudgetListEdit')->getList(['company_id'=>$this->member_info->company_id]);
        $rate=Loader::model('base/MaterialRateItem')->getList(['company_id'=>$this->member_info->company_id,'type'=>2]);
        $assign_data= [
            'bookDefault'=>empty($book) ? '' : $book,
            'rateDefault'=>empty($rate) ? '' : $rate,
        ];
        $this->assign($assign_data);
        return $this->fetch('rate_item_and_book');
    }
    /*添加预算的默认费率*/
    public function addBudgetBookAndRate($id=""){
        if(empty($id)) return self::showJsonReturnCode(1003);
        if ($this->request->isPost()){
            try {
                $data = $this->request->post();
                $com_id = $this->member_info->company_id;
                $budget_book = Loader::model('base/BudgetDefaultBook')->where(['project_id' => $id, 'status' => 1])->find();
//            $budget=Loader::model('base/DesignBudget')->setCacheProjectData()['budget_book'];
//            if(array_key_exists($id,$budget) ){  //判断该项目是否创建了预算
//                return self::showJsonReturnCode("1001",[],'预算存在');
//            }


                if (!empty($budget_book)) {  //判断该项目是否创建了预算
                    return self::showJsonReturnCode("1001", [], '预算存在');
                }
                if (empty($data)) return self::showJsonReturnCode(1003, [], "请联系管理员创建好预算书封面信息模板和固定的费率");
                if (!isset($data["book"])) return self::showJsonReturnCode(1003, [], "请联系管理员创建好预算书封面信息模板");
                if (!isset($data["budget_type"])) return self::showJsonReturnCode(1003, [], "请选择该项目的预算类型");
                $re = Loader::model('base/BudgetDefaultBook')->saveData($data, $id, $com_id);
                if ($re['code'] == "1001") {
                    return Loader::model("base/BudgetDefaultRate")->saveData($data, $id, $com_id);
                } else {
                    return $re;
                }
            }catch (Exception $e){
                return self::showReturnCodeWithOutData(1008,$e->getMessage());
            }
        }else{
            return self::showJsonReturnCode(1003);
        }
    }
    /*修改预算的信息页面*/
    public function changeInfo($pro_id=""){
        if (empty($pro_id)) return self::showReturnCode(1003);
        if ($this->request->isPost()){
            $list=$this->showEasyUiJsonListNo('base/BudgetDefaultBook',false,['project_id'=>$pro_id]);
            return $list;
        }else{
           $arr=[
               'data_url'=>url('changeInfo',['pro_id'=>$pro_id]),
               'title'=>'预算信息修改',
               'pro_id'=>$pro_id,
               'add_url'=>url('saveChangeInfo',['pro_id'=>$pro_id])
           ];
           $this->assign($arr);
           self::echoHtml();
           return $this->fetch('design_extract/change_design_info');
        }
    }
    /*保存修改后的预算信息*/
    public function saveChangeInfo($pro_id=""){
        if (empty($pro_id)) return self::showReturnCode(1003);
        if ($this->request->isPost()){
            $data=$this->request->post();
            $model=new BudgetDefaultBook();
            $re=$model->saveChangeInfo($data,$pro_id);
            return $re;
        }else{
            return self::showReturnCode(1003);
        }
    }
    /*修改预算装饰项名称和备注页面*/
    public function changeDataInfo($pro_id=""){
        if (empty($pro_id)) return self::showReturnCode(1003);
        if ($this->request->isPost()){
            $model = new BudgetDefaultProject();
            $arr=[];
            $arr['rows']=[];
            $i=1;
            $list=$model->getList(['project_id'=>$pro_id,'company_id'=>$this->member_info->company_id,'pid'=>0],'guid,name,desc');
            if (!empty($list)){
                foreach ($list as $value){
                    $value['iconCls']='icon-blank';
                    $value['name']=$i.'、'.$value['name'];
                    $value['editor']=false;
                    $arr['rows'][]=$value;
                    $i++;
                    $children=$model->getList(['project_id'=>$pro_id,'company_id'=>$this->member_info->company_id,'pid'=>$value['guid']],'guid,pid,name,unit,number,price,desc');
                    if (!empty($children)){
                        foreach ($children as $item){
                            $item['iconCls']='icon-blank';
                            $item['_parentId']=$value['guid'];
                            $arr['rows'][]=$item;
                        }
                    }
                }
            }
            $arr['total']=count($arr['rows']);
            return $arr;
        }else{
            $project=Project::quickGet($pro_id);
            $arr=[
                'data_url'=>url('changeDataInfo',['pro_id'=>$pro_id]),
                'title'=>$project['project_name'],
                'pro_id'=>$pro_id,
                'add_url'=>url('saveChangeDataInfo',['pro_id'=>$pro_id])
            ];
            $this->assign($arr);
            self::echoHtml();
            return $this->fetch('design_extract/change_design_data_info');
        }
    }
    /*修改预算装饰项名称和备注后保存*/
    public function saveChangeDataInfo($pro_id=""){
        if (empty($pro_id)) return self::showReturnCode(1003);
        if ($this->request->isPost()){
            $data=$this->request->post();
            $model=new BudgetDefaultProject();
            $re=$model->saveChangeDataInfo($data);
            return $re;
        }else{
            return self::showReturnCode(1003);
        }
    }
    /*更换预算类型*/
    public function editBudgetType($pro_id=""){
        if (empty($pro_id)) return self::showReturnCode(1003);
        if ($this->request->isPost()){
            $data=$this->request->post();
            $model=new BudgetDefaultBook();
            $re=$model->editBudgetType($data,$pro_id);
            return $re;
        }else{
            $arr=[

            ];
            $this->assign($arr);
            self::echoHtml();
            return $this->fetch('edit_budget_type');
        }
    }
}